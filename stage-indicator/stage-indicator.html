<template id="stage-indicator-template">
    <link rel="stylesheet" href="/stage-indicator/stage-indicator.css">
</template>

<script>
    class StageIndicator extends HTMLElement {

        static get observedAttributes() {
            return ["value", "title"];
        };

        get value() {
            return this.getAttribute("value") || this._value;
        };

        set value(value) {
            this._value = value;
        };

        get title() {
            return this.getAttribute('title') || this._title;
        }

        set title(value) {
            this._title = value;
        }

        constructor() {
            super();
            this._value;
            this._title;
            this._isInitialized;
            this.onStageClickHandle;
            this.onProgressHandle;
        }

        dispose() {

            this.removeEventListener('click', this.onStageClickHandle);
            this.removeEventListener('onProgressChanged', this.onProgressHandle);

            this.onStageClickHandle = null;
            this.onProgressHandle = null;
            this._value = null;
            this._title = null;
            this._isInitialized = null;
        }


        connectedCallback() {

            this._isInitialized = true;
            const currentDocument = document.currentScript.ownerDocument;
            const template = currentDocument.querySelector('#stage-indicator-template').content.cloneNode(true);

            this.appendChild(template);

            if (this.value) {
                this.setStagePosition(this.value);
                this.setCompleted(this.parentElement.value)
            };

            this.onStageClickHandle = this.onStageClicked.bind(this);
            this.onProgressHandle = this.onProgress.bind(this);

            this.addEventListener("click", this.onStageClickHandle);
            this.parentElement.addEventListener("onProgressChanged", this.onProgressHandle);
        }

        disconnectedCallback() {
            this.dispose();
        }

        attributeChangedCallback(name, oldValue, newValue) {

            if (!this._isInitialized)
                return;

            this.setStagePosition(newValue);
            this.setCompleted(this.parentElement.value);
        }

        setStagePosition(value) {

            if (value)
                this.style.left = value + "%";
        }

        setCompleted(progress) {

            const value = Number(this.value);

            if (!isNaN(progress)) {

                const numericProgress = Number(progress);

                numericProgress >= value
                    ? this.classList.add('completed')
                    : this.classList.remove('completed');
            }
            else {

                if (this.parentElement.value === this.title) {

                    this.parentElement.value = this.value;
                    this.classList.add('completed');
                }
                else
                    this.classList.remove('completed');
            }
        }

        onStageClicked(e) {

            const position = this.value;

            this.parentElement.value = position;
            this.classList.add('completed');
        };

        onProgress(event) {

            const progress = Number(event.detail.progress);

            this.setCompleted(progress);
        }
    }

    customElements.define('stage-indicator', StageIndicator);
</script>