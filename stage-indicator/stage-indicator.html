<template id="stage-indicator-template">
    <link rel="stylesheet" href="/stage-indicator/stage-indicator.css">
    <div class="stage-indicator"></div>
</template>

<script>
    class StageIndicator extends HTMLElement {

        static get observedAttributes() {
            return ["value"];
        };

        constructor() {
            super();

            this._value;
            this._isInitialized;
        }

        get value() {
            return this.getAttribute("value") || this._value;
        };

        set value(value) {
            this._value = value;
        };

        connectedCallback() {

            const currentDocument = document.currentScript.ownerDocument;
            const template = currentDocument.querySelector('#stage-indicator-template').content.cloneNode(true);

            this.appendChild(template);
            this._isInitialized = true;

            if (this.value) {
                this.setStagePosition(this.value);
                this.setCompleted();
            }

            this.addEventListener("click", this.stageClicked);

            this.parentElement.addEventListener("onProgressChanged", (e) => {

                const progress = Number(e.detail.progress);
                const value = Number(this.value);
                const element = this.querySelector('.stage-indicator');

                if (progress >= value)
                    element.classList.add("completed");
                else
                    element.classList.remove("completed");
            });

            //this.parentElement.addEventListener("onProgressChanged", this.onProgressHandler);
        }

        disconnectedCallback() {

            this.removeEventListener('click', this.stageClicked);
        }

        attributeChangedCallback(name, oldValue, newValue) {

            if (!this._isInitialized)
                return;

            this.setStagePosition(newValue);
        }

        stageClicked(e) {

            const element = this.querySelector('.stage-indicator');
            const progress = e.target.getAttribute('data-value');

            this.parentElement.value = progress;
            element.classList.add('completed');
        };

        setStagePosition(value) {

            if (value) {
                const element = this.querySelector('.stage-indicator');

                element.setAttribute('data-value', value);
                element.style.left = value + "%";
            }
        }

        setCompleted() {
            const progress = Number(this.parentElement.value);
            const value = Number(this.value);
            const element = this.querySelector('.stage-indicator');

            if (progress >= value)
                element.classList.add('completed');
            else
                element.classList.remove('completed');
        }

        onProgressHandler(e) {
            const progress = Number(e.detail.progress);
            const value = Number(this.value);
            const element = this.querySelector('.stage-indicator');

            if (progress >= value)
                element.classList.add("completed");
            else
                element.classList.remove("completed");
        }
    }

    customElements.define('stage-indicator', StageIndicator);
</script>