<template id="stage-indicator-template">
    <link rel="stylesheet" href="/stage-indicator/stage-indicator.css">
    <div class="stage-indicator"></div>
</template>

<script>
    class StageIndicator extends HTMLElement {

        static get observedAttributes() {
            return ["type", "value", "completed"];
        };

        constructor() {
            super();

            this._type = null;
            this._value = null;
            this._stageIndicator = null;
            this._completed = null;
        }

        get type() {
            return this.getAttribute("type") || this._type;
        };

        set type(value) {
            this._type = value;
        };

        get value() {
            return this.getAttribute("value") || this._value;
        };

        set value(value) {
            this._value = value;
        };

        get completed() {
            return this.hasAttribute('completed')
        }

        set completed(value) {
            if (value)
                this.setAttribute('completed', '');
            else
                this.removeAttribute('completed');
        }

        connectedCallback() {

            const currentDocument = document.currentScript.ownerDocument;
            const template = currentDocument.querySelector('#stage-indicator-template').content.cloneNode(true);

            this.appendChild(template);

            console.log("staged-indicator connected");

            this._stageIndicator = this.querySelector('.stage-indicator');

            const type = this.getAttribute('type');
            const value = this.getAttribute('value');
            const progress = this.parentElement.getAttribute('value');

            if (type !== null)
                this._setStageType(type);

            if (value !== null)
                this._setStagePosition(value);

            if (progress !== null)
                this._setCompleted(progress);

            this._stageIndicator.addEventListener("click", this._stageClicked);
        }

        disconnectedCallback() {
            this.removeEventListener('click', this._stageClicked);
            this.removeEventListener('progressChanged', this._onProgressChange);
        }

        attributeChangedCallback(name, oldValue, newValue) {

            switch (name) {

                case 'type':
                    this._setStageType(newValue);
                    break;
                case 'value':
                    this._setStagePosition(newValue)
                    break;
                case 'completed':
                    this._setCompleted(newValue);
                default:
                    break;
            }
        }

        _stageClicked(e) {

            const progress = e.target.getAttribute('data-value');

            let event = new CustomEvent("fastTrackProgress", {
                detail: {
                    progress: progress
                },
                bubbles: true
            });

            this.dispatchEvent(event);
        };

        _setStageType(type) {

            if (this._stageIndicator !== null) {

                const types = ["major", "minor"];

                this._stageIndicator.classList.remove(...types);
                this._stageIndicator.classList.add(type);
            }
        }

        _setStagePosition(value) {

            if (this._stageIndicator !== null) {

                this._stageIndicator.setAttribute('data-value', value);
                this._stageIndicator.style.left = value + "%";
            }
        }

        _setCompleted(value) {

            const stageValue = Number(this.getAttribute('value'));
            const progress = Number(value);
            const element = this.querySelector('.stage-indicator');

            if (progress >= stageValue)
                element.classList.add('completed');
            else
                element.classList.remove('completed');
        }
    }

    customElements.define('stage-indicator', StageIndicator);
</script>