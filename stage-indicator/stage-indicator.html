<template id="stage-indicator-template">
    <link rel="stylesheet" href="/stage-indicator/stage-indicator.css">
    <div class="stage-indicator"></div>
</template>

<script>
    class StageIndicator extends HTMLElement {

        static get observedAttributes() {
            return ["type", "value", "completed"];
        };

        constructor() {
            super();
            
            this._type = null;
            this._value = null;
            this._stageIndicator = null;
            this._completed = null;
        }

        get type() {
            return this.getAttribute("type") || this._type;
        };

        set type(value) {
            this._type = value;
        };

        get value() {
            return this.getAttribute("value") || this._value;
        };

        set value(value) {
            this._value = value;
        };

        get completed() {
            return this.hasAttribute('completed')
        }

        set completed(value) {
            if(value)
                this.setAttribute('completed', '');
            else
                this.removeAttribute('completed');
        }


        connectedCallback() {
            
            const currentDocument = document.currentScript.ownerDocument;
            const template = currentDocument.querySelector('#stage-indicator-template').content.cloneNode(true);

            this.appendChild(template)

            this._stageIndicator = this.querySelector('.stage-indicator');

            const type = this.getAttribute('type');
            const value = this.getAttribute('value');

            if(type !== null)
                this._setStageType(type);

            if(value !== null)
                this._setStagePosition(value);

            this._stageIndicator.addEventListener("click", this._stageClicked); 

             console.log("stagged-indicator connected");
        }

        disconnectedCallback() {
            this.removeEventListener('click', this._stageClicked);
         }   


        attributeChangedCallback(name, oldValue, newValue) {          

            switch (name) {

                case 'type':
                    this._setStageType(newValue);
                    break;
                case 'value':
                    this._setStagePosition(newValue)
                    break;
                case 'completed': 
                    this.setCompleted(newValue);
                default: break;
            }
        }

        _stageClicked(e) {
            
            const progress = e.target.getAttribute('data-value');
            

            let event = new CustomEvent("UpdateProgress", {
                detail: {
                    progress: progress
                },
                bubbles: true
            });

            this.dispatchEvent(event);
        };

        _setStageType(type) {                       

            if (this._stageIndicator !== null) {

                const types = ["major", "minor"];

                this._stageIndicator.classList.remove(...types);
                this._stageIndicator.classList.add(type);
            }
        }

        _setStagePosition(value) {            

            if (this._stageIndicator !== null) {

                this._stageIndicator.setAttribute('data-value', value);
                this._stageIndicator.style.left = value + "%";
            }
        }

        setCompleted() {
           
           if(this.completed) 
                this._stageIndicator.classList.add('completed');
            else
                this._stageIndicator.classList.remove('completed');
           
        }

    }

    customElements.define('stage-indicator', StageIndicator);
</script>