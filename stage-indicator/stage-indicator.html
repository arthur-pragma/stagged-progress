<template id="stage-indicator-template">
    <link rel="stylesheet" href="/stage-indicator/stage-indicator.css">
    <div class="stage-indicator"></div>
</template>

<script>
    class StageIndicator extends HTMLElement {

        static get observedAttributes() {
            return ["value", "title"];
        };

        constructor() {
            super();
            this._value;
            this._title;
            this._isInitialized;
            this.onProgressHandle;
        }

        get value() {
            return this.getAttribute("value") || this._value;
        };

        set value(value) {
            this._value = value;            
        };

        get title() {
            return this.getAttribute('title') || this._title;
        }

        set title(value) {
            this._title = value;
        }

        connectedCallback() {

            this._isInitialized = true;
            const currentDocument = document.currentScript.ownerDocument;
            const template = currentDocument.querySelector('#stage-indicator-template').content.cloneNode(true);

            this.appendChild(template);          

            if (this.value) {
                this.setStagePosition(this.value);
                this.setCompleted(this.parentElement.value)
            };

            this.addEventListener("click", this.stageClicked);

            this.onProgressHandle = this.onProgress.bind(this);
            this.parentElement.addEventListener("onProgressChanged", this.onProgressHandle);
        }

        disconnectedCallback() {

            this.removeEventListener('click', this.stageClicked);
            this.removeEventListener('onProgressChanged', this.onProgressHandle);
        }

        attributeChangedCallback(name, oldValue, newValue) {          

            if (!this._isInitialized)
                return;

            this.setStagePosition(newValue);
            this.setCompleted(this.parentElement.value);
        }

        stageClicked(e) {

            const element = this.querySelector('.stage-indicator');
            const progress = e.target.getAttribute('data-value');

            this.parentElement.value = progress;
            element.classList.add('completed');
        };

        setStagePosition(value) {

            if (value) {
                const element = this.querySelector('.stage-indicator');

                element.setAttribute('data-value', value);
                element.style.left = value + "%";
            }
        }

        setCompleted(progress) {           
            
            const value = Number(this.value);
            const element = this.querySelector('.stage-indicator');

            if(!isNaN(progress)) {
                
                const numericProgress = Number(progress);

                  if (numericProgress >= value)
                    element.classList.add('completed');
                else
                    element.classList.remove('completed');
            }
            else {

                if(this.parentElement.value === this.title) {

                    this.parentElement.value = this.value;
                    element.classList.add('completed');
                }                    
            }      
        }

        onProgress(event) {
            
            const progress = Number(event.detail.progress);

            this.setCompleted(progress);        
        }
    }

    customElements.define('stage-indicator', StageIndicator);
</script>