<template id="staged-progress-template">
    <link rel="stylesheet" href="/staged-progress/staged-progress.css">
    <div class="progress">
        <span></span>
        <!-- change this to progress tag -->
    </div>
</template>

<script>
    class StagedProgress extends HTMLElement {

        constructor() {

            super();

            this._progress = null;
            this._value = null;
            this._status = null;
        }

        static get observedAttributes() {
            return ["value", "status"];
        };

        get value() {
            return this.getAttribute('value') || this._value;
        };

        set value(value) {
            this._value = value;
        };

        get status() {
            return this.getAttribute('status') || this._status;
        }

        set status(value) {
            this._status = value;
        }

        connectedCallback() {

            const currentDocument = document.currentScript.ownerDocument;
            const template = currentDocument.querySelector('#staged-progress-template').content.cloneNode(true);

            this.appendChild(template);

            this._progress = this.querySelector('.progress');

            this.addEventListener('UpdateProgress', (e) => {
                this._value = e.detail.progress;
                this.setProgress(this._value);
            });

            const initialProgress = this.getAttribute('value');
            const initialStatus = this.getAttribute('status');

            if (initialProgress !== null) {
                this._value = initialProgress;
                this.setProgress(this._value);
            }          

            if(initialStatus !== null) {
                this._status = initialStatus;
                this.setStatus(this._status);
            }
        }

        disconnectedCallback() {
            // dispose here
        }

        attributeChangedCallback(name, oldValue, newValue) {

            switch(name) {

                case "value":
                    this.setProgress(newValue);
                    break;
                case "status":
                    this.setStatus(newValue);
                    break;
                default:
                    break;
            }            
        }

        setProgress(value) {

            if (this._progress !== null) {

                const span = this._progress.querySelector('span');

                this._progress.setAttribute('data-progress', value);

                span.style.width = value + "%"; // css variable for this, width is expansive (transform is less expensive)
            }
        }

        setStatus(value) {

            if (this._progress != null) {                

                this._progress.setAttribute('data-status', value);               
            }
        }
    }

    customElements.define('staged-progress', StagedProgress);
</script>