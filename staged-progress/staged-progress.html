<template id="staged-progress-template">
    <link rel="stylesheet" href="/staged-progress/staged-progress.css">
    <div class="progress">
        <span></span>
    </div>
</template>

<script>
    class StagedProgress extends HTMLElement {

        static get observedAttributes() {
            return ["value"];
        };

        get value() {
            return this.getAttribute('value') || this._value;
        };

        set value(value) {

            if (!this.validProgress(value) || this._value === value)
                return;

            this._value = value;
            this.setProgress(value);
        };

        constructor() {
            super();
            this._isIntialized;
            this._value;
            this._min = 0;
            this._max = 100;
        }

        dispose() {
            this._value = null;
            this._isIntialized = null;
            this._min = null;
            this._max = null;            
        }

        connectedCallback() {   
                   
            const currentDocument = document.currentScript.ownerDocument;
            const template = currentDocument.querySelector('#staged-progress-template').content.cloneNode(true);

            this.appendChild(template);
            this._isIntialized = true;           

            if (this.value)
                this.setProgress(this.value);
        }

        disconnectedCallback() {   
            this.dispose();
        }

        attributeChangedCallback(name, oldValue, newValue) {            
            
            if (this._isIntialized === true)
                this.setProgress(newValue);
        }

        setProgress(value) {           

            if (this.validProgress(value)) {
                const progress = this.querySelector('.progress');
                const span = progress.querySelector('span');

                progress.setAttribute('data-progress', value);
                span.style.width = value + "%";

                this.dispatchEvent(new CustomEvent('onProgressChanged', {
                    detail: {
                        progress: value
                    },                    
                }));
            }
        }

        validProgress(value) {
            return true;
            //return value && (value >= this._min) && (value <= this._max)
        }
    }

    customElements.define('staged-progress', StagedProgress);
</script>