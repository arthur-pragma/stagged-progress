<template id="staged-progress-template">
    <link rel="stylesheet" href="/staged-progress/staged-progress.css">
    <div class="progress">
        <span></span>
        <!-- change this to progress tag -->
    </div>
</template>

<script>
    class StagedProgress extends HTMLElement {

        constructor() {

            super();

            this._progress = null;
            this._value = null;
            this._status = null;
        }

        static get observedAttributes() {
            return ["value", "status"];
        };

        get value() {
            return this.getAttribute('value') || this._value;
        };

        set value(value) {
            this._value = value;
        };

        get status() {
            return this.getAttribute('status') || this._status;
        }

        set status(value) {
            this._status = value;
        }

        connectedCallback() {

            const currentDocument = document.currentScript.ownerDocument;
            const template = currentDocument.querySelector('#staged-progress-template').content.cloneNode(true);

            console.log("stagged-progress connected");

            this.appendChild(template);

            this._progress = this.querySelector('.progress');

            const initialProgress = this.getAttribute('value');
            const initialStatus = this.getAttribute('status');

            if (initialProgress !== null) {
                this._value = initialProgress;
                this._setProgress(this._value);
            }

            if (initialStatus !== null) {
                this._status = initialStatus;
                this._setStatus(this._status);
            }

            this.addEventListener('UpdateProgress', this._onUpdateProgress);
        }

        disconnectedCallback() {
            // dispose here
             this.removeEventListener('UpdateProgress', this._onUpdateProgress);
        }

        attributeChangedCallback(name, oldValue, newValue) {

            switch (name) {

                case "value":
                    this._setProgress(newValue);
                    break;
                case "status":
                    this._setStatus(newValue);
                    break;
                default:
                    break;
            }
        }

        _setProgress(value) {

            if (this._progress !== null) {

                const span = this._progress.querySelector('span');

                this._progress.setAttribute('data-progress', value);
                span.style.width = value + "%"; // css variable for this, width is expansive (transform is less expensive)

                  console.log("stagged-progress set progress");
            }
        }

        _setStatus(value) {

            if (this._progress != null)
                this._progress.setAttribute('data-status', value);
        }

        _onUpdateProgress(event) {
            this._value = event.detail.progress;
            this._setProgress(this._value);
        }
    }

    customElements.define('staged-progress', StagedProgress);
</script>